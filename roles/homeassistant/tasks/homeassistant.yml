---
# https://github.com/linuxserver/docker-homeassistant#parameters

- name: "Prepare task variables"
  ansible.builtin.set_fact:
    homeassistant_service_id: "homeassistant"
    homeassistant_config: "{{ homeassistant_default_config | combine(homeassistant_config, recursive=true) }}"
    homeassistant_docker_settings: "{{ homeassistant_docker_settings_default | combine(homeassistant_docker_settings) }}"

- name: "Create service directories"
  ansible.builtin.file:
    path: "{{ homeassistant_install_dir }}"
    state: "directory"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0770"

- name: "Template configuration.yml"
  ansible.builtin.template:
    src: "configuration.yaml.j2"
    dest: "{{ homeassistant_install_dir }}/configuration.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

- name: "Ensure {{ homeassistant_docker_settings.network }} network exists"
  when: homeassistant_docker_settings.network != "host"
  community.general.docker_network:
    name: "{{ homeassistant_docker_settings.network }}"
    state: "present"

- name: "Run homeassistant container"
  community.general.docker_container:
    name: "{{ homeassistant_service_id }}"
    image: "{{ homeassistant_avahi_image_name }}:{{ homeassistant_avahi_image_tag }}"
    networks:
      - name: "{{ homeassistant_docker_settings.network }}"
    state: "started"
    env: "{{ homeassistant_env_default | combine(homeassistant_env) }}"
    ports:
      - "{{ homeassistant_port }}:8123"
      - "{{ homeassistant_config.homekit.port }}:{{ homeassistant_config.homekit.port }}"
    volumes:
      - "{{ homeassistant_install_dir }}:/config"
    restart_policy: "unless-stopped"